name: Orchestrate Minimal Benchmark and Docs

on:
  push:
    branches: [main]
  pull_request:
    types: [labeled, synchronize, opened, reopened]

permissions:
  actions: write
  contents: write
  pull-requests: write

jobs:
  guard:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if benchmark should run
        id: check
        run: |
          echo "ğŸ›¡ï¸  Guard job: Checking execution conditions..."
          
          EVENT_NAME="${{ github.event_name }}"
          echo "ğŸ“‹ Event type: $EVENT_NAME"
          
          if [[ "$EVENT_NAME" == "push" ]]; then
            # For push events, we already filter by branch in the trigger
            # So if we're here, it's a push to main - always run
            echo "ğŸš€ Push event to main branch detected"
            echo "âœ… Push to main - proceeding with benchmark"
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "$EVENT_NAME" == "pull_request" ]]; then
            # For PR events, check base branch and labels
            LABELS="${{ join(github.event.pull_request.labels.*.name, ' ') }}"
            BASE="${{ github.event.pull_request.base.ref }}"

            echo "ğŸ¯ Base branch: $BASE"
            echo "ğŸ·ï¸  PR labels: $LABELS"

            if [[ "$BASE" != "main" ]]; then
              echo "âŒ Base branch is not 'main' - skipping benchmark"
              echo "should_run=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "âœ… Base branch check passed (main)"

            if echo "$LABELS" | grep -q "run benchmark minimal"; then
              echo "âœ… Found 'run benchmark minimal' label"
              echo "should_run=true" >> $GITHUB_OUTPUT
            elif echo "$LABELS" | grep -q "run benchmarks all"; then
              echo "âœ… Found 'run benchmarks all' label"
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Required benchmark labels not found"
              echo "â„¹ï¸  Expected labels: 'run benchmark minimal' or 'run benchmarks all'"
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Unexpected event type: $EVENT_NAME"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Guard decision summary
        run: |
          echo "ğŸ›¡ï¸  Guard Job Summary:"
          echo "ğŸ¯ Should run benchmarks: ${{ steps.check.outputs.should_run }}"
          
          EVENT_NAME="${{ github.event_name }}"
          
          if [ "${{ steps.check.outputs.should_run }}" == "true" ]; then
            echo "âœ… All conditions met - proceeding with benchmark and docs"
            echo "ğŸš€ Next: Benchmark execution will start"
            
            if [[ "$EVENT_NAME" == "push" ]]; then
              echo "ğŸ“ Trigger: Push to main branch"
            else
              echo "ğŸ“ Trigger: PR with benchmark label"
            fi
          else
            echo "â­ï¸  Conditions not met - skipping benchmark workflow"
            
            if [[ "$EVENT_NAME" == "pull_request" ]]; then
              echo "ğŸ’¡ To run benchmarks on PRs, ensure:"
              echo "   â€¢ PR targets 'main' branch"
              echo "   â€¢ PR has 'run benchmark minimal' or 'run benchmarks all' label"
            else
              echo "ğŸ’¡ Push events only run benchmarks when pushed to 'main'"
            fi
          fi

  benchmarks:
    needs: guard
    if: needs.guard.outputs.should_run == 'true'
    uses: ./.github/workflows/benchmark-minimal.yml
    permissions:
      contents: write
      pull-requests: write

  docs:
    needs: [guard, benchmarks]
    if: success() && needs.guard.outputs.should_run == 'true'
    uses: control-toolbox/CTActions/.github/workflows/documentation.yml@main
    permissions:
      contents: write
      pull-requests: write
