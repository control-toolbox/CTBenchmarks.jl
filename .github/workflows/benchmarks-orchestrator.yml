name: Orchestrate Minimal Benchmark and Docs

on:
  push:
    branches: [main]
  pull_request:
    types: [labeled, synchronize, reopened]

permissions:
  actions: write
  contents: write
  pull-requests: write

jobs:
  guard:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if benchmark should run
        id: check
        run: |
          LABELS="${{ join(github.event.pull_request.labels.*.name, ' ') }}"
          BASE="${{ github.event.pull_request.base.ref }}"

          echo "Base branch: $BASE"
          echo "Labels: $LABELS"

          if [[ "$BASE" != "main" ]]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if echo "$LABELS" | grep -q "run benchmark minimal" || echo "$LABELS" | grep -q "run benchmarks all"; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  benchmarks:
    needs: guard
    if: needs.guard.outputs.should_run == 'true'
    uses: ./.github/workflows/benchmark-minimal.yml
    permissions:
      contents: write
      pull-requests: write

  docs:
    needs: benchmarks
    if: success() && needs.guard.outputs.should_run == 'true'
    uses: ./.github/workflows/documentation.yml
    permissions:
      contents: write
      pull-requests: write

  notify-failure:
    needs: [guard, benchmarks, docs]
    if: failure() && needs.guard.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR with failure notification
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const failedJobs = [];
            if (needs.benchmarks.result === 'failure') failedJobs.push('Benchmarks');
            if (needs.docs.result === 'failure') failedJobs.push('Documentation');

            const comment = `
            ## ❌ Workflow Failed
            The following jobs failed:
            ${failedJobs.map(job => `- ${job}`).join('\n')}
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

  notify-success:
    needs: [guard, benchmarks, docs]
    if: success() && needs.guard.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR with success notification
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            let comment = `
            ## ✅ Benchmark and Documentation Complete
            - ✅ Benchmarks executed
            - ✅ Documentation updated
            `;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
