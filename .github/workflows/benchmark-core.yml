name: Benchmark Core

on:
  workflow_call:

permissions:
  contents: write
  pull-requests: write

jobs:
  run-benchmark-core:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      # ---------------------------
      # Checkout Repository
      # ---------------------------
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ðŸ“‹ Repository checkout status
        run: |
          echo "âœ… Repository checked out successfully"
          echo "ðŸ“ Current directory: $(pwd)"
          echo "ðŸ“Š Total files: $(find . -type f | wc -l)"

      # ---------------------------
      # Setup Julia Environment
      # ---------------------------
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1.11'

      - name: ðŸ”§ Julia setup status
        run: |
          echo "âœ… Julia $(julia --version | cut -d' ' -f3) installed successfully"
          echo "ðŸ“ Julia location: $(which julia)"

      - uses: julia-actions/cache@v2

      - name: ðŸ’¾ Julia cache status
        run: echo "âœ… Julia package cache configured"

      - uses: julia-actions/julia-buildpkg@v1
        with:
          ignore-no-cache: true

      - name: ðŸ”¨ Package build status
        run: |
          echo "âœ… Julia package built successfully"
          echo "ðŸ“¦ CTBenchmarks package ready for use"

      # ---------------------------
      # Run Core Benchmark
      # ---------------------------
      - name: Run core benchmark
        id: benchmark
        timeout-minutes: 30
        run: |
          echo "ðŸš€ Starting core benchmark execution..."
          echo "â±ï¸  Benchmark timeout: 30 minutes"
          
          julia --color=yes -e '
            include("scripts/benchmark-core.jl")
            out = main()
            println("ðŸ“„ Output file: ", out)
            open("benchmark_output.txt", "w") do f
              write(f, string(out))
            end
            println("ðŸ’¾ Output path saved to benchmark_output.txt")
          '
          
          echo "âœ… Benchmark execution completed"
          echo "benchmark_success=true" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Benchmark results validation
        if: steps.benchmark.outputs.benchmark_success == 'true'
        run: |
          echo "ðŸ” Validating benchmark results..."
          
          if [ -f "benchmark_output.txt" ]; then
            OUTPUT_PATH=$(cat benchmark_output.txt)
            echo "âœ… Benchmark output file found: $OUTPUT_PATH"
            
            if [ -f "$OUTPUT_PATH" ]; then
              FILE_SIZE=$(stat -f%z "$OUTPUT_PATH" 2>/dev/null || stat -c%s "$OUTPUT_PATH" 2>/dev/null || echo "unknown")
              LINE_COUNT=$(wc -l < "$OUTPUT_PATH")
              echo "âœ… Benchmark JSON file created successfully"
              echo "ðŸ“ File size: $FILE_SIZE bytes"
              echo "ðŸ“ File lines: $LINE_COUNT"
              echo "ðŸ“ File location: $OUTPUT_PATH"
              
              # Show first few lines of the JSON for verification
              echo "ðŸ”Ž JSON content preview:"
              head -10 "$OUTPUT_PATH"
              if [ $LINE_COUNT -gt 10 ]; then
                echo "   ... (truncated, $LINE_COUNT total lines)"
              fi
            else
              echo "âŒ ERROR: Benchmark JSON file not found at $OUTPUT_PATH"
              exit 1
            fi
          else
            echo "âŒ ERROR: benchmark_output.txt not found"
            exit 1
          fi

    # ---------------------------
    # Commit benchmark results to current branch
    # ---------------------------
      - name: Commit benchmark results to current branch
        if: steps.benchmark.outputs.benchmark_success == 'true'
        run: |
          echo "ðŸ”§ Configuring git user..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          echo "âœ… Git user configured"

          echo "ðŸŒ¿ Checking current git state..."
          echo "Current HEAD: $(git rev-parse --short HEAD)"
          echo "Current branch: $(git branch --show-current || echo 'DETACHED HEAD')"
          
          # Ensure we're on the correct branch for PR
          if [ -n "${{ github.head_ref }}" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
            echo "ðŸ”„ This is a PR, switching to branch: $BRANCH_NAME"
            git checkout -B "$BRANCH_NAME"
            echo "âœ… Now on branch: $(git branch --show-current)"
          else
            BRANCH_NAME="${{ github.ref_name }}"
            echo "ðŸ”„ This is a push, switching to branch: $BRANCH_NAME"  
            git checkout -B "$BRANCH_NAME"
            echo "âœ… Now on branch: $(git branch --show-current)"
          fi

          echo "ðŸ“Š Adding benchmark results to current branch..."
          
          # Add the benchmark JSON
          git add docs/src/assets/benchmark-core/data.json

          # Check if file was added
          if git diff --cached --name-only | grep -q "docs/src/assets/benchmark-core/data.json"; then
            echo "âœ… docs/src/assets/benchmark-core/data.json staged for commit"
            
            # Show what's being committed
            echo "ðŸ“‹ Files to be committed:"
            git diff --cached --name-status
          else
            echo "âš ï¸  docs/src/assets/benchmark-core/data.json not staged (possibly no changes)"
          fi

          # Commit only if there are changes
          if ! git diff --cached --quiet; then
            echo "ðŸ“ Committing benchmark results to current branch..."
            git commit -m "ðŸ“Š Add core benchmark results" -m "Generated by automated benchmark workflow" -m "Results saved to docs/src/assets/benchmark-core/data.json" -m "Ready for documentation generation"
            echo "âœ… Benchmark results committed successfully"
            
            echo "ðŸš€ Pushing changes to branch: $BRANCH_NAME"
            git push origin "$BRANCH_NAME"
            echo "âœ… Benchmark results pushed to $BRANCH_NAME"
          else
            echo "â„¹ï¸  No changes detected in benchmark results"
            echo "ðŸ“Š Current results are identical to previous run"
          fi

      - name: ðŸ“‹ Benchmark workflow summary
        if: steps.benchmark.outputs.benchmark_success == 'true'
        run: |
          echo "ðŸ“Š Benchmark workflow summary:"
          echo "âœ… Benchmark execution: SUCCESS"
          echo "ðŸ“ Results saved to: docs/src/assets/benchmark-core/data.json"
          echo "ðŸŒ¿ Results committed to: ${{ github.head_ref || github.ref_name }} branch"
          echo "ðŸ“š Ready for documentation generation"
          echo "ðŸŽ‰ Core benchmark workflow completed successfully!"